<?php
// $Id: project.module,v 1.139 2004/01/15 19:20:25 kjartan Exp $

// project nodes    -> project_projects
// project releases -> project_releases

// issue nodes      -> project_issues
// issue comments   -> project_comments

if (file_exists('modules/project/project.inc')) {
  require_once 'modules/project/project.inc';
  require_once 'modules/project/release.inc';
  require_once 'modules/project/issue.inc';
  require_once 'modules/project/comment.inc';
  require_once 'modules/project/mail.inc';
}

function project_help($section) {
  switch ($section) {
    case 'admin/system/modules':
      return t('Enables teams to track outstanding items which need resolution.');
    case 'admin/help#project':
      $help = '<h3>Mailhandler support</h3>'.
              '<p>Basic mail format:</p>'.
              '<pre>'.
              "Type: project\n".
              "Project: chatbox\n".
              "Category: bug report\n".
              "Version: cvs\n".
              "Priority: normal\n".
              "Status: active\n".
              "Component: code\n\n".
              "Whatever I type here will be the body of the node.\n".
              '</pre>'.
              "<p>See the mailhandler help for more information on using the mailhandler module.</p>\n";
     return $help;
  }
}

function project_system($field) {
  $info = array(
    'description' => project_help('admin/system/modules')
  );
  return $info[$field];
}

function project_node($field) {
  $info['name'] = t('project');

  return $info[$field];
}

function project_perm() {
  return array(
    'administer projects',
    'maintain projects',
    'access projects',
    'maintain project issues',
    'access project issues'
  );
}

function project_settings() {
  if (!file_check_directory(file_create_path(variable_get('project_directory_issues', 'issues')))) {
    $error['project_directory_issues'] = theme('error', t('Directory does not exist, or is not writable.'));
  }

  $output = form_textfield(t('Release directory'), 'project_release_directory', variable_get('project_release_directory', ''), 50, 255, t('Leave this blank if project maintainers are to create their own release packages. This is useful if releases are generated by an external tool.'));
  $output .= form_textfield(t('Issue directory'), 'project_directory_issues', variable_get('project_directory_issues', 'issues'), 30, 255, t("Subdirectory in the directory '%dir' where attachment to issues will be stored.", array('%dir' => variable_get('file_directory_path', 'files') . FILE_SEPARATOR)) . $error['project_directory_issues']);

  if (module_exist('mailhandler')) {
    // TODO: move this stuff to mailhandler.module ?
    $items = array(t('<none>'));
    $result = db_query('SELECT mail FROM {mailhandler} ORDER BY mail');
    while ($mail = db_result($result, $i++)) {
      $items[$mail] = $mail;
    }

    $output .= form_select(t('Reply-to address on e-mail notifications'), 'project_reply_to', variable_get('project_reply_to', ''), $items);
  }
  $header = array_merge(array(t('type')), array_keys(node_invoke_nodeapi($node, 'settings')));

  foreach (array('project_issue', 'project_project') as $name) {
    $node->type = $name;
    $cols = array();
    foreach (node_invoke_nodeapi($node, 'settings') as $setting) {
      $cols[] = array('data' => $setting, 'align' => 'center', 'width' => 55);
    }
    $rows[] = array_merge(array(module_invoke($name, 'node', 'name')), $cols);
  }

  $output .= form_item(t('Default settings'), theme('table', $header, $rows), t('Default options for new content.'));
  return $output;
}

function project_cron() {
  if (variable_get('project_release_directory', '') && time() - variable_get('project_release_directory_last', 0) > variable_get('project_release_directory_interval', 24 * 60 * 60)) {
    variable_set('project_release_directory_last', time());
    project_release_cron();
  }

  if (time() - variable_get('project_digest_last', 0) > variable_get('project_digest_interval', 7 * 24 * 60 * 60)) {
    variable_set('project_digest_last', time());
    project_mail_digest();
  }

  if (time() - variable_get('project_reminder_last', 0) > variable_get('project_reminder_interval', 28 * 7 * 24 * 60 * 60)) {
    variable_set('project_reminder_last', time());
    project_mail_reminder();
  }

  $result = db_query('SELECT * FROM {project_issues} p LEFT JOIN {node} n USING (nid) WHERE p.state = 2 AND n.changed < %d', time() - 14 * 24 * 60 * 60);
  while ($node = db_fetch_object($result)) {
    foreach (array('nid', 'pid', 'category', 'component', 'priority', 'assigned', 'state', 'title') as $var) {
      $comment->$var = $node->$var;
    }
    $comment->state = 7;
    project_comment_save($comment);
  }
}

function project_link($type, $node = 0, $main = 0) {
  $links = array();
  switch ($type) {
    case 'page':
      if (user_access('access projects')) {
        $links[] = l(t('projects'), 'project', array('title' => t('View all projects.')));
      }
      break;
    case 'node':
      if ($node->type == 'project_project') {
        if (!user_access('administer nodes') && node_access('update', $node)) {
          $links[] = l(t('edit'), "node/edit/$node->nid");
        }
        if (node_access($node, 'update')) {
          $links = array(l(t('add new release'), "project/$node->uri/releases/add"));
        }
        if ($node->issues && user_access('access project issues')) {
          $links[] = l(t('issues'), "project/$node->uri/issues");
        }
      }
      if ($node->type == 'project_issue') {
        if (user_access('maintain project issues')) {
          $project = node_load(array('nid' => $node->pid, 'type' => 'project_project'));
          $links[] = l(t('update issue'), "project/comments/add/$node->nid");
          if ($node->fid) {
            $links[] = l(t('download attachment'), "project/$project->uri/issues/download/$node->nid");
          }
        }
      }
      break;
    case 'system':
      if (user_access('access projects')) {
        menu('project', t('projects'), 'project_page', 1);
        menu('project/releases', t('releases'), 'project_page', 0);
        $result = db_query("SELECT version FROM {project_releases} WHERE status = 1 AND path <> '' GROUP BY version ORDER BY created DESC");
        $versions = array();
        while ($object = db_fetch_object($result)) {
          $version = preg_replace('/^(.+?)(\.)?(?:\d+)?$/', '\1\2\3\4\5\6', $object->version);
          if (!in_array($version, $versions)) {
            $versions[$version] = $version == $object->version ? $version : $version .'x';
            menu("project/releases/$version", $versions[$version], 'project_page', $i++);
          }
        }
      }

      if (user_access('maintain projects')) {
        menu('node/add/project_project', t('project'), 'node_page');
      }

      if (user_access('access project issues')) {
        $categories = project_issue_category(0, 1);

        // Figure out active project if possible.
        if (arg(0) == 'project' && arg(1)) {
          $project = node_load(array('nid' => db_result(db_query("SELECT nid FROM {project_projects} WHERE uri = '%s'", arg(1)), 0)));
        }
        elseif (arg(0) == 'node' && is_numeric(arg(2))) {
          if (!$project = node_load(array('nid' => arg(2), 'type' => 'project_project'))) {
            if ($issue = node_load(array('nid' => arg(2), 'type' => 'project_issue'))) {
              $project = node_load(array('nid' => $issue->pid, 'type' => 'project_project'));
            }
          }
        }

        // If we have a project make some specific menu items for easy navigation.
        if ($project) {
          project_project_menu($project);
        }

        // Create all project issues menu.
        menu('project/issues', t('issues'), 'project_page', 1);
        if ($GLOBALS['user']->uid) {
          menu('project/issues/user', t('my issues'), 'project_page', 0);
        }
        foreach ($categories as $cat => $category) {
          menu("project/issues/$cat", $category, 'project_page', 2);
        }
        menu('project/issues/add', t('submit'), 'project_page', 3);
        menu('project/issues/statistics', t('statistics'), 'project_page', 4);
        menu('project/issues/search', t('search'), 'project_page', 5);
      }

      // Populate the node/add menu
      if (user_access('maintain project issues')) {
        $categories = project_issue_category(0, 0);
        foreach ($categories as $cat => $category) {
          menu("node/add/project_issue/$cat", $category, 'node_page', 1);
        }
        menu('node/add/project_issue', 'issue', 'node_page', 0, 0);
      }
      break;
  }

  return $links;
}

function project_nodeapi(&$node, $op, $arg = 0) {
  if ($op == 'form post' && $node->type == 'project_issue' && $node->pid) {
    return form_item(t('Posting PHP code'), t('Wrap your PHP code inside <code>[?php ?]</code> tags and it will be colorised automatically.'));
  }
}

function project_filter_highlight($text) {
  $text = trim(stripslashes($text));
  return '<div class="php">'. highlight_string("<?php\n$text\n?>", 1) .'</div>';
}

function project_filter($text) {
  $text = preg_replace('@\[(\?(php)?|%)(.+?)(\?|%)\]@se', "project_filter_highlight('$3')", $text);
  return $text;
}

function project_page() {
  global $user;

  if (!user_access('access projects')) {
    drupal_goto(url());
  }

  if ($_POST['op'] == t('Subscribe') && $_POST['edit']['nid']) {
    global $user;
    db_query('DELETE FROM {project_subscriptions} WHERE nid = %d AND uid = %d', $_POST['edit']['nid'], $user->uid);
    db_query('INSERT INTO {project_subscriptions} (nid, uid, level) VALUES (%d, %d, %d)', $_POST['edit']['nid'], $user->uid, $_POST['edit']['level']);
    drupal_goto(url('node/view/'. $_POST['edit']['nid']));
  }
  switch (arg(1)) {
    case 'releases':
      print theme('page', project_release_overview(arg(2)));
      break;
    case 'issues':
      project_issue_page($node);
      break;
    case 'comments':
      if (user_access('access project issues')) {
        project_comment_page($node);
        break;
      }
    default:
      if (arg(1)) {
        if (is_numeric($id = arg(1) == 'view' ? arg(2) : arg(1))) {
          $node = node_load(array('nid' => $id, 'type' => 'project_project'));
        }
        else {
          $node = node_load(array('nid' => db_result(db_query("SELECT nid FROM {project_projects} WHERE uri = '%s'", arg(1)), 0), 'type' => 'project_project'));
        }
        if ($node->nid) { // Show project details
          switch (arg(2)) {
            case 'releases':
              project_release_page($node);
              break;
            case 'issues':
              if ($node->issues && user_access('access project issues')) {
                project_issue_page($node);
                break;
              }
            default:
              print theme('page', node_view($node, 0, 1));
          }
        }
      }
      else { // Show project overview
        project_page_overview();
      }
  }
}

function project_page_overview() {
  if (!is_numeric($_GET['tid']) && function_exists('taxonomy_get_vocabularies') && count($vocabularies = taxonomy_get_vocabularies('project'))) { // Show an overview of vocabularies
    $vocabulary = reset($vocabularies);

    $output = '<div style="float: left; padding-right: 5em;">';

    $terms = taxonomy_get_tree($vocabulary->vid);
    foreach ($terms as $term) {
      $count = taxonomy_term_count_nodes($term->tid);
      $browse[] = l($term->name, 'project', NULL, "tid=$term->tid") ." ($count)";
      $items = array();
      $result = db_query("SELECT n.nid, title FROM {node} n INNER JOIN {term_node} r ON n.nid = r.nid WHERE n.type = 'project_project' AND r.tid = %d AND n.status = 1 ORDER BY title", $term->tid);
      while ($node = db_fetch_object($result)) {
        $items[] = l($node->title, "node/view/$node->nid");
      }
      $output .= theme('item_list', $items, $term->name);
    }

    $output .= '</div>';
    $output .= '<div style="float: left;">';
    $output .= theme('item_list', $browse, t('Details'));
    $output .= '</div>';

    print theme('page', $output);
  }
  else {
    if (is_numeric($_GET['tid']) && $_GET['tid']) {
      $term = taxonomy_get_term($_GET['tid']);
    }

    if ($term) { // Paged full view
      $result = pager_query("SELECT DISTINCT(n.nid) FROM {node} n INNER JOIN {term_node} r ON n.nid = r.nid WHERE n.type = 'project_project' AND r.tid =". check_query($_GET[tid]) .' AND n.status = 1 ORDER BY title', variable_get('project_overview', 10));
      while ($node = db_fetch_object($result)) {
        $output .= node_view(node_load($node), 1);
      }
      if ($pager = theme("pager", NULL, variable_get('project_overview', 10), 0, array('tid' => $_GET['tid']))) {
        $output .= $pager;
      }
    }
    else { // Show table form
      $header = array(
        array('data' => t('project'), 'field' => 'n.title', 'sort' => 'asc'),
        array('data' => t('updated'), 'field' => 'n.changed'),
        array('data' => t('issues'), 'colspan' => 4, 'field' => 'count')
      );
      $result = db_query("SELECT n.nid, n.title, n.changed, COUNT(p.nid) AS count FROM {node} n LEFT JOIN {project_issues} p ON n.nid = p.pid AND p.state < 3 WHERE n.type = 'project_project' AND n.status = 1 GROUP BY n.nid %s", tablesort_sql($header));
      while ($node = db_fetch_object($result)) {
        $rows[] = array(
          l($node->title, "node/view/$node->nid"),
          array('data' => project_interval(time() - $node->changed, 2), 'align' => 'right'),
          array('data' => "$node->count open", 'align' => 'right'),
          l(t('view'), "project/$node->nid/issues"),
          l(t('search'), "project/$node->nid/issues/search"),
          l(t('submit'), 'node/add/project_issue', NULL, "project=$node->nid")
        );
      }

      $output = '<div class="project">'. theme('table', $header, $rows) .'</div>';
    }

    print theme('page', $output);
  }
}

function project_search($keys) {
  $find = array();
  $result = db_query_range("SELECT n.nid, n.title, n.created, u.uid, u.name FROM {project_issues} p INNER JOIN {node} n USING (nid) INNER JOIN {users} u USING (uid) WHERE body LIKE '%%%s%%' ORDER BY changed DESC", $keys, 0, 100);
  while ($node = db_fetch_object($result)) {
    $find[] = array("title" => $node->title, "link" => url("node/view/$node->nid"), "user" => format_name($node), 'date' => $node->created);
  }
  return $find;
}

// Special project stuff
function project_types() {
  return array('project_project', 'project_issue');
}

function project_invoke(&$node, $function, $arg1 = 1, $arg2 = 0) {
  if (in_array($node->type, project_types())) {
    $function = 'project_'. $node->type .'_'. $function;
    return $function($node, $arg1, $arg2);
  }
}

// Node functions
/*function project_node($field) {
  global $user;

  $info['name'] = t('project');
  $info['description'] = t('All and everything related to creating and maintaining projects.');

  return $info[$field];
}*/

function project_form(&$node, &$help, &$error, &$param) {
  // TODO: add type selector
  switch ($node->type) {
    case 'project_project':
      $node->type = 'project_project';
      return project_project_form($node, $help, $error, $param);
    default:
      $node->type = 'project_issue';
      return project_issue_form($node, $help, $error, $param);
  }
}

function project_validate(&$node) {
  if (!in_array($node->type, project_types())) {
    return $error['type'] = t('System error: invalid project type.');
  }
  return project_invoke($node, 'validate');
}

function project_view($node, $main = 0) {
  return project_invoke($node, 'view', $main);
}

function project_load($node) {
  return project_invoke($node, 'load');
}

function project_insert($node) {
  return project_invoke($node, 'insert');
}

function project_update($node) {
  return project_invoke($node, 'update');
}

function project_delete($node) {
  return project_invoke($node, 'delete');
}

function project_access($op, $node) {
  switch ($node->type) {
    case 'project_project':
      return project_project_access($op, $node);
    case 'project_issue':
      return project_issue_access($op, $node);
  }
}

function project_interval($timestamp, $max = 0) {
  $units = array('1 year|%count years' => 31536000, '1 week|%count weeks' => 604800, '1 day|%count days' => 86400, '1 hour|%count hours' => 3600, '1 min|%count min' => 60, '1 sec|%count sec' => 1);
  foreach ($units as $key => $value) {
    $key = explode('|', $key);
    if ($timestamp >= $value) {
      $output .= ($output ? ' ' : '') . format_plural(floor($timestamp / $value), $key[0], $key[1]);
      $timestamp %= $value;
      if (++$level == $max) {
        break;
      }
    }
  }
  return ($output) ? $output : t('0 sec');
}

function project_file_download($file) {
  if (user_access('access project issues')) {
    $file = file_create_path($file);
    if ($mime = db_result(db_query("SELECT file_mime FROM {project_issues} WHERE file_path = '%s'", $file))) {
      return array("Content-type: $mime");
    }
    if ($mime = db_result(db_query("SELECT file_mime FROM {project_comments} WHERE file_path = '%s'", $file))) {
      return array("Content-type: $mime");
    }
  }
}

?>
